---
- name: Update, Install qemu-agent, Start and Enable Services, and Reboot Server
  hosts: all  # Ganti dengan nama atau grup host target Anda
  become: yes  # Untuk mendapatkan akses superuser (biasanya root)

  tasks:
    - name: Update repository cache on Debian
      apt:
        update_cache: yes
      when: ansible_distribution == 'Debian'

    - name: Update repository cache on CentOS
      yum:
        name: "*"
        state: latest
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: Install qemu-guest-agent on Debian
      apt:
        name: qemu-guest-agent
        state: present
      when: ansible_distribution == 'Debian'

    - name: Install qemu-guest-agent on CentOS
      yum:
        name: qemu-guest-agent
        state: present
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: Start qemu-guest-agent service on Debian
      service:
        name: qemu-guest-agent
        state: started
      when: ansible_distribution == 'Debian'

    - name: Start qemu-guest-agent service on CentOS
      service:
        name: qemu-ga
        state: started
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: Reboot the VM
      reboot:
        reboot_timeout: 300
        test_command: uptime
      when: ansible_distribution == 'Debian' or ansible_distribution == 'CentOS'
